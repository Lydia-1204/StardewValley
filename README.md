# 星露谷风格农场生活模拟游戏

> Tongji University · Software Engineering · 2024 Fall Program Design Paradigms Project

## 项目简介

本项目是一款星露谷风格的农场生活模拟游戏，围绕“经营农场 + 社区交互 + 探索冒险 + 角色成长”四条主线展开。玩家需要规划耕种、养殖、资源采集与经济系统，在与镇民互动的同时探索森林、矿洞等场景。我们以 Cocos2d-x + C++ 为主要技术栈，强调类与多态、STL、异常处理等现代 C++ 特性，以确保复杂系统间的解耦与健壮性。

## 团队信息

| 角色 | 姓名 | 主要职责 | 占比 |
| --- | --- | --- | --- |
| 2351882 | 王小萌 | 总体架构、角色创建、背包与工具栏、NPC 交互、Mini 地图、资源/资金管理、异常处理 | 32% |
| 2351591 | 刘彦含 | 动物与农作物系统、项目文档、Git 管理、资金面板、技能成长、市场价格、睡眠机制 | 28% |
| 2354178 | 陈美希 | 地图与碰撞、场景切换、NPC 交互与任务联动 | 25% |
| 2351273 | 邓语乐 | 工具交互、玩家系统、任务设计、角色动作表现 | 15% |

指导教师：赵钦佩  
学院/专业：同济大学计算机科学与技术学院 · 软件工程  
完成日期：2024-12-23

## 程序设计范式与技术特点

- **STL 容器**：大量使用 `std::vector` 等容器管理地图元素、NPC、动物与背包内容，实现动态扩展。
- **类与多态**：以面向对象的方式封装 NPC、工具、作物、动物等实体，复用通用接口并根据行为多态化实现细节。
- **模板与泛型**：对通用算法与资源容器进行模板化抽象，减少重复逻辑。
- **异常处理**：关键模块加入异常捕获，提升运行期稳定性与调试效率。

## 功能概览

### 基础功能

1. **农场经营**：耕种、浇水、施肥、收获；饲养牛/鸡/羊/猪/狗/猫等动物，并管理它们的健康与心情。
2. **社区交互**：与镇民对话、接取任务、赠送礼物、发展友谊及恋爱关系，完成后获得奖励。
3. **冒险探索**：在森林、矿洞、池塘等多地图切换，使用不同工具采集矿石、木材、鱼类等资源。
4. **角色成长**：农业、采矿、钓鱼、养殖等技能树随行为提升，可在属性面板中查看状态与成长进度。

### 扩展功能

1. **Mini 地图**：通过快捷键 `M` 查看全局定位，星形标记当前玩家位置，支持室内/室外/矿山切换。
2. **资金管理与商店**：可视化的资金面板与商店 UI，支持购买工具、礼物及出售产物。
3. **市场价格系统**：根据玩家持有量动态调整商品价格（如矿石 <30 稀有高价，≥30 走低），模拟供需机制。
4. **睡眠与时间快进**：在床边交互即可睡眠，暂停世界并将时间跳转至次日 8:00，恢复精力。
5. **工具动画与长按操作**：使用工具时触发对应动作，支持连续作业与行走速度切换。
6. **UI/交互增强**：任务窗口、角色/动物属性面板、心情与关系管理、精力守恒提示等。

## 功能技术细节

### 农场经营

- **生长周期驱动**：按游戏内时间累积进度与浇水状态决定作物成长；三天未浇水即视为干旱死亡。
- **动态纹理**：根据阶段切换贴图以展示生长动画，成熟时弹出提示；逾期未收获则枯萎。
- **动物 AI**：采用与玩家不同的移动逻辑沿预设路径漫游，并根据朝向切换精灵帧，营造生动效果。
- **动物交互**：右键查看状态，左键抚摸或喂食可提升健康/心情/好感；状态满值时可掉落对应产物。

### 社区交互

- **距离感知 UI**：靠近 NPC 时对话气泡由半透明变为不透明，提示可互动状态。
- **任务流**：首次对话触发任务领取，完成后再次交互即可结算奖励；之后进入随机闲聊模式。
- **礼物系统**：通过商店购买礼物，提升特定 NPC 好感度并解锁亲密关系。

### 冒险探索

- **工具上下文**：依据当前地图与手持工具决定可用动作（镐头挖矿、鱼竿钓鱼、斧头砍树等）。
- **资源累计**：采集成功时背包资源数量+1，并增加对应技能经验值。
- **属性可视化**：快捷键菜单实时展示经验条，方便玩家制定培养策略。

### 角色个人成长

- **属性面板**：使用快捷键 `P` 打开，显示钓鱼/种植/养殖/挖矿等技能等级以及精力、心情等指标。
- **阈值反馈**：技能达到 100 时将标识染成红色，强调该领域已达专家级。

### Mini 地图

- **全局定位**：快捷键 `M` 切换显隐，支持多场景地图拼接，星星与红色标签定位玩家。
- **场景同步**：室内外/矿山切换时保持坐标跟踪，帮助玩家快速规划路线。

### 资金与市场系统

- **初始定价**：每种可售物品设定基准价，商店面板可浏览价格表。
- **交易逻辑**：左键售卖、`BUY` 按钮购买，实时更新背包与资金；支持升级工具或购买礼物。
- **市场调节**：以持有量为输入对售价进行分段计算，模拟供过于求/供不应求场景。

### 睡眠与时间快进

- **触发条件**：玩家在家中且靠近床位时点击即可入睡，场景暂停。
- **快进机制**：再次点击床唤醒后时间跳至次日 08:00，并恢复满精力，提供合理节奏控制。

## 使用与操作说明

- **动物养殖**：左键互动；手持食物左键双击喂食；右键查看属性面板。
- **植物种植**：手持水壶左键浇水；手持肥料左键施肥。
- **工具栏**：左键使用工具，右键丢弃；`Shift` 可切换行走速度减半。
- **商店交互**：左键售卖，右键丢弃（礼物除外），点击 `BUY` 按钮购买。
- **快捷键总览**：`E` 暂停/继续 · `M` Mini 地图 · `C` 使用当前工具 · `V` 丢弃工具 · `P` 玩家属性 · `F` 任务窗口。
- **NPC 对话**：左键优先触发任务对话，第二次点击确认任务完成并领取奖励；再次对话进入随机日常聊天；右键打开好感度界面。

## 运行环境建议

- 操作系统：Windows 10/11
- IDE：Visual Studio 2022（含 C++ 桌面开发组件）
- 引擎依赖：Cocos2d-x（仓库已包含相关源码）
- 构建方式：打开 `proj.win32/StardewValley0.sln`，选择 Win32 Debug/Release 目标进行编译运行。

## 本地环境搭建与运行步骤

以下步骤假设你刚从远程仓库全新克隆此项目，且本机尚未进行任何配置（全部在 Windows 10/11 上测试通过）。

### 1. 安装必备工具

1. **Visual Studio 2022**（Community 版即可），安装时勾选“使用 C++ 的桌面开发”工作负载，确保包含：
	- MSVC v143 工具集
	- Windows 10/11 SDK（10.0.19041 及以上）
	- CMake/ Ninja（VS 会自动安装，可供后续使用）
2. **Git 2.40+**：用于克隆仓库。
3. **Python 2.7.x**：`cocos2d\download-deps.py` 与 `cocos2d\setup.py` 仍依赖 Python 2 语法（如 `raw_input`），请安装官方 Python 2.7 并加入 PATH。
	- 若机器上同时存在多版本 Python，可通过 `py -2 --version` 验证调用的是 2.7。

### 2. 克隆仓库

```powershell
git clone https://github.com/Lydia-1204/StardewValley.git
cd StardewValley
```

（仓库已内置 `cocos2d` 源码，无需额外拉取子模块。）

### 3. 下载 Cocos2d-x 第三方依赖

仓库中仅包含引擎源码，运行前需拉取外部二进制依赖：

```powershell
py -2 cocos2d\download-deps.py
```

脚本会自动将官方依赖包解压到 `cocos2d/external` 内，首次运行耗时较长；若下载失败，可切换网络或重试。

### 4. 注册环境变量（可选但推荐）

运行官方脚本为当前用户写入 `COCOS_X_ROOT`、`COCOS_CONSOLE_ROOT` 等环境变量，方便使用 cocos 命令行工具与后续脚本：

```powershell
py -2 cocos2d\setup.py
```

脚本将在 Windows 注册表（或 macOS/Linux 的 shell profile）中写入配置，并提示重启终端使之生效。若你只需 VS 工程，可跳过此步；需要运行 `cocos` 命令或构建 Android/iOS 平台时请务必执行。

### 5. 打开解决方案并编译

1. 双击 `proj.win32/StardewValley0.sln` 以 Visual Studio 打开解决方案。
2. 在“解决方案资源管理器”中将 `StardewValley0` 设为启动项目（默认即为该项目）。
3. 工具栏选择 **Win32** 平台，然后按需切换 `Debug` 或 `Release` 配置。
4. 执行 **Build > Build Solution**（或快捷键 `Ctrl+Shift+B`）。
	- 首次编译会在 `proj.win32/Debug.win32`（或 `Release.win32`）生成引擎 DLL、PDB 以及游戏可执行文件，并自动把 `Resources/` 目录复制到输出目录。

### 6. 运行与调试

- 在 Visual Studio 中按 `F5`（调试运行）或 `Ctrl+F5`（不调试运行）。
- 也可在输出目录直接运行 `proj.win32/Debug.win32/StardewValley0.exe`。
- 如果看到缺少 DLL/资源提示，重复执行 `build` 或手动删除输出目录后重新编译，确保 `download-deps.py` 成功拉取依赖。

### 7. 常见问题

| 问题 | 解决办法 |
| --- | --- |
| `fatal error C1083: Cannot open include file` | 确认已运行 `cocos2d\download-deps.py` 且 `external` 目录完整；必要时重新执行脚本。 |
| `MSB8036: The Windows SDK version was not found` | 重新运行 Visual Studio Installer，勾选对应的 Windows 10/11 SDK。 |
| 运行时报找不到资源 | 确认第一次构建是否成功，将 `Resources` 目录同步到 `proj.win32/Debug.win32/Resources`。 |

完成以上步骤即可在本地构建并运行项目，后续只需保持仓库最新、必要时重新执行依赖下载脚本即可。

## 许可证与贡献

本仓库面向教学与课程展示使用，若需引用或二次开发，请联系团队成员或导师以确认授权。欢迎通过 Pull Request 或 Issue 提交建议与改进。